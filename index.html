<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ã–ÄŸretmen AdayÄ± Puanlama Sistemi</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root { --ink: #1a1a2e; --paper: #f5f0e8; --accent: #c8410a; --green: #2d6a4f; --muted: #7a7a8a; --border: #d9d2c4; --card: #fff; --shadow: 0 2px 20px rgba(26,26,46,.09); }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--paper);color:var(--ink);min-height:100vh;padding-bottom:2rem}
.nav{background:var(--ink);color:#fff;padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:60px}
.nav-brand{font-family:'DM Serif Display',serif;font-size:1.15rem}
.nav-tabs{display:flex;gap:.2rem}
.nav-tab{padding:.4rem 1rem;border-radius:6px;border:none;background:transparent;color:rgba(255,255,255,.5);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;cursor:pointer;transition:all .2s}
.nav-tab.active,.nav-tab:hover{background:rgba(255,255,255,.14);color:#fff}
.statusbar{text-align:center;padding:.4rem 1rem;font-size:.82rem;font-weight:500;display:none}
.statusbar.visible{display:block} .statusbar.open{background:var(--green);color:#fff} .statusbar.closed{background:var(--accent);color:#fff} .statusbar.waiting{background:#777;color:#fff}
.view{display:none;padding:2rem 1.25rem;max-width:750px;margin:0 auto}
.view.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.75rem;box-shadow:var(--shadow);margin-bottom:1.25rem}
.card-title{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:.25rem}
.card-sub{color:var(--muted);font-size:.85rem;margin-bottom:1.4rem}
label{display:block;font-size:.78rem;font-weight:600;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:.4rem}
input[type=text], input[type=number], input[type=password], select{width:100%;padding:.7rem .95rem;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:1rem;color:var(--ink);background:var(--paper);outline:none;transition:border-color .2s;margin-bottom:.9rem}
input:focus, select:focus{border-color:var(--ink)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.45rem;padding:.7rem 1.5rem;border-radius:10px;border:none;font-family:'DM Sans',sans-serif;font-size:.92rem;font-weight:600;cursor:pointer;transition:all .2s;width:100%}
.btn-primary{background:var(--ink);color:#fff} .btn-primary:hover:not(:disabled){background:#2d2d4a;}
.btn-danger{background:var(--accent);color:#fff} .btn-success{background:var(--green);color:#fff}
.btn-outline{background:transparent;color:var(--ink);border:1.5px solid var(--border)}
.btn-sm{padding:.45rem 1rem;font-size:.82rem;width:auto}
.btn:disabled{opacity:.4;cursor:not-allowed}
.score-display{text-align:center;margin:1rem 0 .4rem}
.score-big{font-family:'DM Serif Display',serif;font-size:5rem;line-height:1;transition:color .2s}
.score-range{color:var(--muted);font-size:.8rem;margin-top:.2rem}
input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:var(--border);outline:none;margin:.9rem 0;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:var(--ink);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2);transition:transform .15s}
.checklist-container { display:flex; flex-direction:column; gap:.6rem; margin-bottom:1.5rem; }
.check-item { display:flex; flex-direction:column; gap:.8rem; background:var(--paper); padding:1.2rem; border-radius:10px; border:1px solid var(--border); }
@media(min-width: 550px) { .check-item { flex-direction:row; align-items:center; justify-content:space-between; } }
.check-item label { margin:0; color:var(--ink); font-weight:500; font-size:.92rem; text-transform:none; letter-spacing:normal; flex:1; cursor:pointer; }
.radio-group { display: flex; gap: 0.5rem; flex-shrink: 0; }
.radio-btn { padding: 0.5rem 1.2rem; border-radius: 8px; border: 1.5px solid var(--border); font-size: 0.85rem; font-weight: 600; color: var(--muted); cursor: pointer; transition: all 0.2s; background: #fff; text-align:center; flex:1; }
.radio-btn.yes.active { background: var(--green); border-color: var(--green); color: #fff; }
.radio-btn.no.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.success-msg{text-align:center;padding:1.8rem 1rem;display:none} .success-icon{font-size:3.2rem;margin-bottom:.6rem}
.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.85rem;margin:1rem 0}
.stat-box{background:var(--paper);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center}
.stat-label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.25rem}
.stat-value{font-family:'DM Serif Display',serif;font-size:1.8rem;color:var(--ink)}
.score-item{display:flex;flex-direction:column;padding:.6rem .8rem;border-radius:8px;font-size:.88rem;margin-bottom:.4rem;background:var(--paper);border:1px solid var(--border)}
.sbadge{display:inline-flex;align-items:center;gap:.4rem;background:var(--paper);border:1px solid var(--border);border-radius:8px;padding:.3rem .75rem;font-size:.8rem;color:var(--muted);margin-bottom:.9rem}
.dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite} .dot.off{background:var(--muted);animation:none}
.student-row{display:flex;align-items:center;justify-content:space-between;padding:.65rem .85rem;border-radius:10px;border:1px solid var(--border);margin-bottom:.5rem;background:var(--paper);}
.student-row.active-session{border-color:var(--green);background:#f0faf5;}
.history-item{border:1px solid var(--border);border-radius:12px;padding:1rem 1.1rem;margin-bottom:.75rem;cursor:pointer;background:var(--card)}
hr{border:none;border-top:1px solid var(--border);margin:1.1rem 0}
.spin{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:rot .7s linear infinite;margin-right:.35rem}
@keyframes rot{to{transform:rotate(360deg)}} @keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}
.toast{position:fixed;bottom:1.4rem;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ink);color:#fff;padding:.65rem 1.3rem;border-radius:10px;font-size:.85rem;font-weight:500;transition:transform .3s ease;z-index:9999;}
.toast.show{transform:translateX(-50%) translateY(0)}
.waiting-screen{text-align:center;padding:2.5rem 1rem}
.demo-box { background:#f9f9f9; padding:1rem; border-radius:10px; margin-top:.5rem; font-size:.85rem;}
.demo-box span { display:inline-block; margin-right:1rem; margin-bottom:.5rem; }
.edit-list-item { display:flex; gap:.5rem; margin-bottom:.5rem; }
</style>
</head>
<body>

<nav class="nav">
  <div class="nav-brand">ğŸ“‹ Puanlama Sistemi</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showView('scorer')">PuanlayÄ±cÄ±</button>
    <button class="nav-tab" onclick="showView('teacher')">Ã–ÄŸretmen</button>
  </div>
</nav>
<div class="statusbar" id="statusBar"></div>

<div class="view active" id="view-scorer">

  <div id="scorerLoginScreen">
    <div class="card">
      <div class="card-title">Sisteme KatÄ±lÄ±n</div>
      <div class="card-sub">LÃ¼tfen deÄŸerlendirme Ã¶ncesi bilgilerinizi eksiksiz girin. Veriler karÅŸÄ±laÅŸtÄ±rmalÄ± analiz iÃ§in kullanÄ±lacaktÄ±r.</div>
      
      <label>AdÄ±nÄ±z ve SoyadÄ±nÄ±z</label>
      <input type="text" id="scorerName" placeholder="Ã–rn: Ahmet YÄ±lmaz">
      
      <label>Cinsiyetiniz</label>
      <select id="scorerGender">
        <option value="">SeÃ§iniz...</option>
        <option value="KadÄ±n">KadÄ±n</option>
        <option value="Erkek">Erkek</option>
      </select>
      
      <label>YaÅŸÄ±nÄ±z</label>
      <input type="number" id="scorerAge" placeholder="Ã–rn: 21">
      
      <label>Genel Not OrtalamasÄ± (GANO)</label>
      <input type="number" step="0.01" id="scorerGpa" placeholder="Ã–rn: 3.20">
      
      <button class="btn btn-primary" onclick="loginScorer()" style="margin-top:1rem">Sisteme Gir â†’</button>
    </div>
  </div>

  <div id="scorerMainScreen" style="display:none">
    <div class="card" id="scorerWaitCard">
      <div class="waiting-screen">
        <div style="font-size:3rem;margin-bottom:1rem">â³</div>
        <h3>Oturum Bekleniyor</h3>
        <p style="color:var(--muted);font-size:.88rem">Ã–ÄŸretmen bir aday iÃ§in oturum aÃ§tÄ±ÄŸÄ±nda burada gÃ¶rÃ¼necek.</p>
        <p style="margin-top:.75rem;font-size:.8rem;color:var(--muted)" id="scorerWelcomeName"></p>
        <button class="btn btn-outline btn-sm" style="margin-top:1.5rem" onclick="logoutScorer()">Ã‡Ä±kÄ±ÅŸ Yap / Bilgileri GÃ¼ncelle</button>
      </div>
    </div>

    <div class="card" id="scorerActiveCard" style="display:none">
      <div class="sbadge"><div class="dot" id="scoreDot"></div><span id="scoreBadgeTxt">Oturum aÃ§Ä±k</span></div>
      <div class="card-title" id="scorerSpeakerTitle">â€”</div>
      
      <div id="scoringStep1">
        <div class="card-sub">AÅŸama 1: KonuÅŸan adayÄ±n genel performansÄ±nÄ± puanlayÄ±n.</div>
        <div class="score-display">
          <div class="score-big" id="scoreDisplay">10</div>
          <div class="score-range">0 â€“ 20 arasÄ±nda holistik puan</div>
        </div>
        <input type="range" min="0" max="20" value="10" id="scoreSlider" oninput="updateSlider(this.value)">
        <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-bottom:1rem"><span>0</span><span>10</span><span>20</span></div>
        <hr>
        <button class="btn btn-primary" onclick="goToStep2()">Sonraki AdÄ±m: Kontrol Listesi â†’</button>
      </div>

      <div id="scoringStep2" style="display:none">
        <div class="card-sub">AÅŸama 2: AdayÄ±n performansÄ±na gÃ¶re aÅŸaÄŸÄ±daki maddeleri iÅŸaretleyin.</div>
        <div class="checklist-container" id="checklist"></div>
        <hr>
        <button class="btn btn-success" id="submitBtn" onclick="submitScores()">âœ“ DeÄŸerlendirmeyi GÃ¶nder</button>
      </div>

      <div class="success-msg" id="successMsg">
        <div class="success-icon" id="successIcon">âœ…</div>
        <h3 id="successTitle">DeÄŸerlendirme AlÄ±ndÄ±!</h3>
        <p id="successDetail"></p>
        <p style="margin-top:.75rem;font-size:.82rem;color:var(--muted)">Sonraki oturum aÃ§Ä±lÄ±nca ekran otomatik gÃ¼ncellenecek.</p>
      </div>
    </div>
  </div>
</div>

<div class="view" id="view-teacher">

  <div class="card" id="teacherLoginCard">
    <div class="card-title">Ã–ÄŸretmen GiriÅŸi</div>
    <div class="card-sub">Panele eriÅŸmek iÃ§in yÃ¶netici ÅŸifresini girin.</div>
    <label>Åifre</label>
    <input type="password" id="teacherPass" placeholder="Åifreniz" onkeydown="if(event.key==='Enter')loginTeacher()"/>
    <button class="btn btn-primary" onclick="loginTeacher()">GiriÅŸ Yap</button>
  </div>

  <div id="teacherPanel" style="display:none">
    
    <div class="card">
      <div class="card-title">Aday & Oturum YÃ¶netimi</div>
      <div style="display:flex;gap:.5rem;margin-bottom:1rem;margin-top:1rem">
        <input type="text" id="newStudentName" placeholder="Aday adÄ± soyadÄ± ekleâ€¦" style="margin-bottom:0;flex:1" onkeydown="if(event.key==='Enter')addStudent()"/>
        <button class="btn btn-outline btn-sm" onclick="addStudent()">+ Ekle</button>
      </div>
      <div id="studentList"></div>
    </div>

    <div class="card" id="activeSessionInfo" style="display:none; border-color:var(--green)">
      <div class="sbadge"><div class="dot" id="teacherDot"></div><span id="teacherBadgeTxt">Oturum aktif</span></div>
      <div class="card-title" id="activeSessionSpeaker">â€”</div>
      <div id="activeScoreCount" style="color:var(--muted);font-size:.88rem;margin-bottom:1rem">HenÃ¼z deÄŸerlendirme gelmedi.</div>
      <button class="btn btn-danger" id="closeBtn" onclick="closeSession()">â–  Oturumu Kapat ve Raporu GÃ¶ster</button>
    </div>

    <div class="card" id="reportCard" style="display:none">
      <div class="card-title">ğŸ“Š KÄ±yaslamalÄ± Rapor</div>
      <div class="card-sub" id="reportSpeaker"></div>
      
      <div class="demo-box" id="rDemoBox"></div>

      <div style="font-weight:bold; margin-top:1.5rem; font-size:.9rem; color:var(--accent)">Holistik DeÄŸerlendirme (AÅŸama 1)</div>
      <div class="stat-grid" style="margin-top:.5rem">
        <div class="stat-box"><div class="stat-label">Ortalama</div><div class="stat-value" id="rMean1">â€”</div></div>
        <div class="stat-box"><div class="stat-label">Std. Sapma</div><div class="stat-value" id="rStd1">â€”</div></div>
      </div>
      
      <div style="font-weight:bold; margin-top:1.5rem; font-size:.9rem; color:var(--green)">Kontrol Listesi (AÅŸama 2)</div>
      <div class="stat-grid" style="margin-top:.5rem">
        <div class="stat-box"><div class="stat-label">Ortalama</div><div class="stat-value" id="rMean2">â€”</div></div>
        <div class="stat-box"><div class="stat-label">Std. Sapma</div><div class="stat-value" id="rStd2">â€”</div></div>
      </div>

      <div style="margin:1.5rem 0 .5rem; font-weight:bold; font-size:.85rem; color:var(--muted)">BÄ°REYSEL DEÄERLENDÄ°RMELER (<span id="rCount">0</span> KiÅŸi)</div>
      <div id="rList"></div>
      <hr>
      <div class="btn-row">
        <button class="btn btn-outline" onclick="copyReport()">ğŸ“‹ Kopyala</button>
        <button class="btn btn-success" onclick="downloadSingleReportCSV()">ğŸ“¥ Excel (CSV) Ä°ndir</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Kontrol Listesi YÃ¶netimi</div>
      <div class="card-sub">PuanlayÄ±cÄ±lara gidecek sorularÄ± buradan dÃ¼zenleyebilirsiniz. <br><small style="color:var(--accent)">(DeÄŸiÅŸiklikler bir sonraki oturumda geÃ§erli olur.)</small></div>
      <div id="teacherChecklistContainer"></div>
      <button class="btn btn-outline btn-sm" style="margin-top:.5rem" onclick="addChecklistItem()">+ Yeni Madde Ekle</button>
      <hr>
      <button class="btn btn-primary" onclick="saveChecklistToDB()">ğŸ’¾ Listeyi Sunucuya Kaydet</button>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem">
        <div class="card-title" style="margin:0">GeÃ§miÅŸ Oturumlar</div>
        <button class="btn btn-outline btn-sm" onclick="downloadAllHistoryCSV()">TÃ¼mÃ¼nÃ¼ Ä°ndir ğŸ“¥</button>
      </div>
      <div id="historyList"></div>
    </div>
    
    <div class="card" id="histDetailCard" style="display:none">
      <button class="btn btn-outline btn-sm" style="margin-bottom:1rem" onclick="closeHistDetail()">â† Geri DÃ¶n</button>
      <div class="card-title" id="hdTitle"></div><div class="card-sub" id="hdDate"></div>
      <div class="demo-box" id="hdDemoBox"></div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Holistik Ort.</div><div class="stat-value" id="hdMean1">â€”</div></div>
        <div class="stat-box"><div class="stat-label">Kontrol Ort.</div><div class="stat-value" id="hdMean2">â€”</div></div>
      </div>
      <div id="hdList"></div>
      <hr>
      <button class="btn btn-success" onclick="downloadSingleReportCSV(true)">ğŸ“¥ Bu Oturumu Excel (CSV) Ä°ndir</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ==========================================
// YENÄ° API LÄ°NKÄ°NÄ°Z
const API = "https://script.google.com/macros/s/AKfycbzOfTepmgkaW7yiz1mewcc7us1VAwKbCMyo7C-taK1qAdzpE-uHQe_O9h4qKqJD7EET/exec";
// ==========================================

let myScorerData = JSON.parse(localStorage.getItem("scorerData") || "null");
let scorerVoted = false; let currentSpeaker = "";
let scorerPollId = null, teacherPollId = null;
let lastReport = null, lastHistItem = null, allHistory = [];
let students = []; let activeStudentIdx = -1;
let savedPass = localStorage.getItem("teacherPass") || "";
let tempScore1 = 0; 
let activeChecklist = []; // Sunucudan gelen maddeler

function showToast(msg, ms=2800){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }
function showView(v){ document.querySelectorAll('.view').forEach(el=>el.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.querySelectorAll('.nav-tab').forEach((el,i)=>el.classList.toggle('active',(i===0&&v==='scorer')||(i===1&&v==='teacher'))); }
function setStatusBar(state,text){ const sb=document.getElementById('statusBar'); if(!state){sb.className='statusbar';return;} sb.className='statusbar visible '+state; sb.textContent=text; }
async function api(params){ const qs = new URLSearchParams(params).toString(); const res = await fetch(API + '?' + qs); if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); }
function updateSlider(v){ const el=document.getElementById('scoreDisplay'); if(el){ el.textContent=v; el.style.color=(v/20)>.65?'#1a6640':(v/20)>.35?'#7a5a10':'#c8410a'; } }

// â•â•â•â•â•â•â•â• SCORER FONKSÄ°YONLARI â•â•â•â•â•â•â•â•
function initScorer(){ 
  if(myScorerData && myScorerData.name){ 
    document.getElementById('scorerLoginScreen').style.display='none'; 
    document.getElementById('scorerMainScreen').style.display='block'; 
    document.getElementById('scorerWelcomeName').textContent='HoÅŸ geldin, '+myScorerData.name+' ğŸ‘‹'; 
    startScorerPoll(); 
  } 
}

function loginScorer(){ 
  const name = document.getElementById('scorerName').value.trim();
  const gender = document.getElementById('scorerGender').value;
  const age = document.getElementById('scorerAge').value.trim();
  const gpa = document.getElementById('scorerGpa').value.trim();
  
  if(!name || !gender || !age || !gpa){ showToast("LÃ¼tfen tÃ¼m alanlarÄ± doldurun."); return; }
  
  myScorerData = { name: name, gender: gender, age: age, gpa: gpa };
  localStorage.setItem("scorerData", JSON.stringify(myScorerData)); 
  initScorer(); 
}

function logoutScorer() {
  localStorage.removeItem("scorerData");
  myScorerData = null;
  if(scorerPollId) clearInterval(scorerPollId);
  document.getElementById('scorerLoginScreen').style.display='block'; 
  document.getElementById('scorerMainScreen').style.display='none'; 
}

function renderScorerChecklist(list) {
  const container = document.getElementById('checklist');
  container.innerHTML = '';
  list.forEach((item, index) => {
    container.innerHTML += `
      <div class="check-item" id="item-${index}">
        <label onclick="selectCheckRadio(${index}, 'yes')">${index+1}. ${item}</label>
        <div class="radio-group">
          <div class="radio-btn yes" onclick="selectCheckRadio(${index}, 'yes')">Evet</div>
          <div class="radio-btn no" onclick="selectCheckRadio(${index}, 'no')">HayÄ±r</div>
        </div>
      </div>`;
  });
}

function selectCheckRadio(index, choice) {
  const itemDiv = document.getElementById(`item-${index}`);
  const yesBtn = itemDiv.querySelector('.radio-btn.yes');
  const noBtn = itemDiv.querySelector('.radio-btn.no');
  if (choice === 'yes') { yesBtn.classList.add('active'); noBtn.classList.remove('active'); } 
  else { noBtn.classList.add('active'); yesBtn.classList.remove('active'); }
}

function startScorerPoll(){ if(scorerPollId) clearInterval(scorerPollId); checkScorerStatus(); scorerPollId=setInterval(checkScorerStatus,3000); }

async function checkScorerStatus(){
  try{
    const data=await api({action:'status'});
    if(JSON.stringify(activeChecklist) !== JSON.stringify(data.checklist)) {
      activeChecklist = data.checklist;
      renderScorerChecklist(activeChecklist);
    }

    if(data.session_active){
      if(data.speaker !== currentSpeaker){ currentSpeaker=data.speaker; scorerVoted=false; openScoringUI(data.speaker); } 
      else if(scorerVoted){ showScorerVotedWait(); } 
      else { showScorerActiveCard(); }
      setStatusBar('open','ğŸŸ¢ Aktif oturum â€” deÄŸerlendirme aÃ§Ä±k');
    } else {
      if(currentSpeaker && !scorerVoted){ showScorerClosed(); }
      currentSpeaker=''; if(!scorerVoted) showScorerWait(); setStatusBar('waiting','â³ Oturum bekleniyorâ€¦');
    }
  }catch(e){}
}

function showScorerWait(){ document.getElementById('scorerWaitCard').style.display='block'; document.getElementById('scorerActiveCard').style.display='none'; }
function showScorerActiveCard(){ document.getElementById('scorerWaitCard').style.display='none'; document.getElementById('scorerActiveCard').style.display='block'; }

function openScoringUI(speaker){
  showScorerActiveCard(); document.getElementById('scoreDot').classList.remove('off'); document.getElementById('scorerSpeakerTitle').textContent=speaker;
  document.getElementById('scoringStep1').style.display='block'; document.getElementById('scoringStep2').style.display='none'; document.getElementById('successMsg').style.display='none';
  const slider=document.getElementById('scoreSlider'); if(slider) slider.value=10; updateSlider(10);
  document.querySelectorAll('.checklist-container .radio-btn').forEach(btn => btn.classList.remove('active'));
  const btn=document.getElementById('submitBtn'); if(btn){btn.disabled=false;btn.textContent='âœ“ DeÄŸerlendirmeyi GÃ¶nder';}
}

function goToStep2() {
  tempScore1 = parseInt(document.getElementById('scoreSlider').value);
  document.getElementById('scoringStep1').style.display = 'none';
  document.getElementById('scoringStep2').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showScorerClosed(){
  document.getElementById('scoreDot').classList.add('off'); document.getElementById('scoringStep1').style.display='none'; document.getElementById('scoringStep2').style.display='none';
  document.getElementById('successIcon').textContent='â›”'; document.getElementById('successTitle').textContent='Oturum kapandÄ±';
  document.getElementById('successDetail').textContent='DeÄŸerlendirme sÃ¼resi doldu.'; document.getElementById('successMsg').style.display='block'; setStatusBar('closed','â›” Oturum kapatÄ±ldÄ±');
}
function showScorerVotedWait(){ showScorerActiveCard(); document.getElementById('scoringStep1').style.display='none'; document.getElementById('scoringStep2').style.display='none'; document.getElementById('successMsg').style.display='block'; }

async function submitScores(){
  const totalItems = activeChecklist.length;
  const answeredItems = document.querySelectorAll('.checklist-container .radio-btn.active').length;
  if (answeredItems < totalItems) { showToast("LÃ¼tfen tÃ¼m maddeleri iÅŸaretleyin."); return; }

  const s1 = tempScore1;
  const yesCount = document.querySelectorAll('.checklist-container .radio-btn.yes.active').length;
  
  // FORMÃœL: (Evet SayÄ±sÄ± / Toplam Soru SayÄ±sÄ±) * 20
  const s2 = Math.round((yesCount / totalItems) * 20);
  
  const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerHTML='<span class="spin"></span>GÃ¶nderiliyorâ€¦';
  scorerVoted=true;
  document.getElementById('successDetail').innerHTML=`KatkÄ±nÄ±z iÃ§in teÅŸekkÃ¼rler.`;
  document.getElementById('successIcon').textContent='âœ…'; document.getElementById('successTitle').textContent='DeÄŸerlendirme AlÄ±ndÄ±!';
  document.getElementById('scoringStep2').style.display='none'; document.getElementById('successMsg').style.display='block';

  try{
    const data=await api({ action:'score', rater:myScorerData.name, gender:myScorerData.gender, age:myScorerData.age, gpa:myScorerData.gpa, score1:s1, score2:s2 });
    if(data.status!=='ok' && data.status!=='duplicate'){
      scorerVoted=false; document.getElementById('scoringStep2').style.display='block'; document.getElementById('successMsg').style.display='none'; btn.disabled=false; btn.textContent='âœ“ DeÄŸerlendirmeyi GÃ¶nder'; showToast(data.message||"Hata.");
    }
  }catch(e){ scorerVoted=false; document.getElementById('scoringStep2').style.display='block'; document.getElementById('successMsg').style.display='none'; btn.disabled=false; btn.textContent='âœ“ DeÄŸerlendirmeyi GÃ¶nder'; showToast("BaÄŸlantÄ± hatasÄ±."); }
}

// â•â•â•â•â•â•â•â• TEACHER FONKSÄ°YONLARI â•â•â•â•â•â•â•â•
async function loginTeacher(){
  const pass = document.getElementById('teacherPass').value.trim();
  if(!pass){showToast("Åifre girin!");return;}
  const btn = document.querySelector('#teacherLoginCard .btn-primary'); btn.disabled=true; btn.textContent="Bekleyin...";
  try {
    const data = await api({action: 'verify_pass', pass: pass});
    if(data.status === 'ok') { localStorage.setItem("teacherPass", pass); savedPass = pass; showTeacherPanel(); } 
    else { showToast("Åifre yanlÄ±ÅŸ!"); }
  } catch(e) { showToast("BaÄŸlantÄ± hatasÄ±!"); }
  btn.disabled = false; btn.textContent = "GiriÅŸ Yap";
}

function showTeacherPanel(){ showView('teacher'); document.getElementById('teacherLoginCard').style.display='none'; document.getElementById('teacherPanel').style.display='block'; renderStudentList(); loadHistory(); startTeacherPoll(); restoreTeacherSession(); }

async function restoreTeacherSession(){
  try{
    const data=await api({action:'status'});
    if(data.students) { students = data.students; renderStudentList(); }
    if(data.checklist) { renderTeacherChecklist(data.checklist); }

    if(data.session_active){
      activeStudentIdx = students.indexOf(data.speaker);
      document.getElementById('activeSessionInfo').style.display='block'; document.getElementById('activeSessionSpeaker').textContent=data.speaker;
      document.getElementById('activeScoreCount').textContent = data.score_count===0 ? 'Bekleniyor...' : data.score_count+' deÄŸerlendirme geldi.';
      document.getElementById('teacherDot').classList.remove('off'); setStatusBar('open','ğŸŸ¢ Aktif oturum â€” deÄŸerlendirme aÃ§Ä±k');
    } else { activeStudentIdx=-1; document.getElementById('activeSessionInfo').style.display='none'; setStatusBar(null); renderStudentList(); }
  }catch(e){}
}

async function addStudent(){
  const inp=document.getElementById('newStudentName'); const name=inp.value.trim(); if(!name) return;
  const btn = inp.nextElementSibling; btn.disabled = true; btn.textContent = "...";
  try {
    const data = await api({action: 'add_student', student: name, pass: savedPass});
    if(data.status === 'ok') { students = data.students; inp.value = ''; renderStudentList(); showToast("Eklendi."); }
  } catch(e) { showToast("Hata!"); }
  btn.disabled = false; btn.textContent = "+ Ekle";
}

async function removeStudent(i){
  if(activeStudentIdx===i){showToast("Aktif oturumu kapatÄ±n.");return;}
  try {
    const data = await api({action: 'remove_student', student: students[i], pass: savedPass});
    if(data.status === 'ok') { students = data.students; if(activeStudentIdx > i) activeStudentIdx--; renderStudentList(); }
  } catch(e) { showToast("Hata!"); }
}

function renderStudentList(){
  const el=document.getElementById('studentList');
  if(!students.length){ el.innerHTML='<div style="text-align:center;padding:1rem;color:var(--muted);font-size:.9rem">Aday listesi boÅŸ.</div>'; return; }
  el.innerHTML='';
  students.forEach((name,i)=>{
    const isActive=(activeStudentIdx===i);
    el.innerHTML+=`<div class="student-row ${isActive?'active-session':''}"><span class="student-name">${isActive?'ğŸŸ¢ ':''}${name}</span><span class="student-count" id="scount-${i}"></span><div class="row-actions">${isActive ? `<button class="btn btn-danger btn-sm" onclick="closeSession()">Kapat</button>` : `<button class="btn btn-success btn-sm" onclick="startSession(${i})" ${activeStudentIdx!==-1?'disabled':''}>AÃ§</button><button class="btn btn-outline btn-sm" onclick="removeStudent(${i})" ${activeStudentIdx!==-1?'disabled':''}>âœ•</button>`}</div></div>`;
  });
}

async function startSession(idx){
  const speaker=students[idx]; document.querySelectorAll('.row-actions .btn').forEach(b=>b.disabled=true);
  try{
    const data=await api({action:'start', speaker:speaker, pass:savedPass});
    if(data.status==='ok'){ activeStudentIdx=idx; renderStudentList(); document.getElementById('activeSessionInfo').style.display='block'; document.getElementById('activeSessionSpeaker').textContent=speaker; document.getElementById('activeScoreCount').textContent='Bekleniyor...'; document.getElementById('reportCard').style.display='none'; document.getElementById('teacherDot').classList.remove('off'); setStatusBar('open','ğŸŸ¢ Aktif oturum â€” deÄŸerlendirme aÃ§Ä±k'); } 
  }catch(e){ showToast("Hata!"); renderStudentList(); }
}

async function closeSession(){
  const btn=document.getElementById('closeBtn'); btn.disabled=true; btn.innerHTML='KapatÄ±lÄ±yor...';
  try{
    const data=await api({action:'close', pass:savedPass});
    activeStudentIdx=-1; renderStudentList(); document.getElementById('activeSessionInfo').style.display='none'; document.getElementById('teacherDot').classList.add('off'); setStatusBar('closed','â›” Oturum kapatÄ±ldÄ±');
    if(!data.scores||data.scores.length===0){ showToast("DeÄŸerlendirme girilmedi."); setStatusBar(null); } 
    else { renderReport(data,'r'); document.getElementById('reportCard').style.display='block'; }
    loadHistory(); btn.disabled=false; btn.textContent='â–  Oturumu Kapat ve Raporu GÃ¶ster';
  }catch(e){ showToast("Hata!"); btn.disabled=false; btn.textContent='â–  Oturumu Kapat'; }
}

function startTeacherPoll(){
  if(teacherPollId) clearInterval(teacherPollId);
  teacherPollId=setInterval(async()=>{
    try{
      const data=await api({action:'status'});
      if(data.students && JSON.stringify(students) !== JSON.stringify(data.students)) { students = data.students; renderStudentList(); }
      if(activeStudentIdx===-1) return;
      if(data.session_active){
        const n=data.score_count; document.getElementById('activeScoreCount').textContent = n===0?'Bekleniyor...':n+' kiÅŸi deÄŸerlendirdi.';
        const sc=document.getElementById('scount-'+activeStudentIdx); if(sc&&n>0) sc.textContent=n+' evrak';
      }
    }catch(e){}
  },3000);
}

// â•â•â•â• KONTROL LÄ°STESÄ° YÃ–NETÄ°MÄ° â•â•â•â•
function renderTeacherChecklist(list) {
  const container = document.getElementById('teacherChecklistContainer');
  container.innerHTML = '';
  list.forEach((item, index) => {
    container.innerHTML += `
      <div class="edit-list-item">
        <input type="text" class="t-check-input" value="${item}" style="margin:0">
        <button class="btn btn-outline btn-sm" onclick="this.parentElement.remove()">Sil</button>
      </div>`;
  });
}
function addChecklistItem() {
  const container = document.getElementById('teacherChecklistContainer');
  container.innerHTML += `<div class="edit-list-item"><input type="text" class="t-check-input" placeholder="Yeni madde..." style="margin:0"><button class="btn btn-outline btn-sm" onclick="this.parentElement.remove()">Sil</button></div>`;
}
async function saveChecklistToDB() {
  const inputs = document.querySelectorAll('.t-check-input');
  const newList = Array.from(inputs).map(inp => inp.value.trim()).filter(val => val !== "");
  if(newList.length === 0) { showToast("Liste boÅŸ olamaz."); return; }
  try {
    const data = await api({ action: 'save_checklist', pass: savedPass, listData: JSON.stringify(newList) });
    if(data.status === 'ok') showToast("Liste gÃ¼ncellendi."); else showToast("Hata!");
  } catch(e) { showToast("BaÄŸlantÄ± hatasÄ±."); }
}


// â•â•â•â• RAPOR VE Ä°NDÄ°RME â•â•â•â•
function generateDemographics(scores) {
  let f=0, m=0, totalAge=0, totalGpa=0;
  scores.forEach(s => {
    if(s.gender === "KadÄ±n") f++; else if(s.gender === "Erkek") m++;
    totalAge += parseInt(s.age) || 0; totalGpa += parseFloat(s.gpa) || 0;
  });
  const n = scores.length || 1;
  return `<span><b>KadÄ±n:</b> ${f}</span> <span><b>Erkek:</b> ${m}</span> <span><b>YaÅŸ Ort:</b> ${(totalAge/n).toFixed(1)}</span> <span><b>GANO Ort:</b> ${(totalGpa/n).toFixed(2)}</span>`;
}

function renderReport(data,prefix){
  const{speaker,scores,stats}=data; 
  if(prefix==='r') lastReport=data; else lastHistItem=data;
  
  // HATA Ã–NLEYÄ°CÄ°: Eski verilerde stats.s1 olmayabilir, geriye dÃ¶nÃ¼k uyumluluk
  const s1_mean = stats.s1 ? stats.s1.mean : (stats.mean || '-');
  const s1_std = stats.s1 ? stats.s1.std : (stats.std || '-');
  const s2_mean = stats.s2 ? stats.s2.mean : '-';
  const s2_std = stats.s2 ? stats.s2.std : '-';

  document.getElementById(prefix+'Mean1').textContent = s1_mean; 
  document.getElementById(prefix+'Std1').textContent = s1_std;
  document.getElementById(prefix+'Mean2').textContent = s2_mean; 
  document.getElementById(prefix+'Std2').textContent = s2_std;
  
  if(prefix==='r') { document.getElementById('reportSpeaker').textContent=speaker; document.getElementById('rCount').textContent=stats.n; document.getElementById('rDemoBox').innerHTML = generateDemographics(scores); }
  else { document.getElementById('hdDemoBox').innerHTML = generateDemographics(scores); }

  const list=document.getElementById(prefix+'List'); list.innerHTML='';
  [...scores].sort((a,b)=>b.score1-a.score1).forEach(s=>{
    const ageInfo = s.age && s.age !== "0" ? ` (${s.gender?s.gender.charAt(0):''}, ${s.age}, ${s.gpa||''})` : '';
    const score2Text = s.score2 !== undefined ? s.score2 : '-';
    list.innerHTML+=`<div class="score-item"><div class="si-header"><span>${s.name} <span style="font-weight:normal;color:var(--muted);font-size:.75rem">${ageInfo}</span></span></div><div class="si-details"><span>Holistik: <b style="color:var(--ink)">${s.score1}/20</b></span><span>Kontrol L.: <b style="color:var(--green)">${score2Text}/20</b></span></div></div>`;
  });
}

function copyReport(d){
  d=d||lastReport; if(!d) return;
  const lines = [ `RAPOR â€” ${d.speaker}`, `Holistik Ort: ${d.stats.s1?d.stats.s1.mean:d.stats.mean} | Kontrol Ort: ${d.stats.s2?d.stats.s2.mean:'-'}`, ``, ...d.scores.map(s=>`${s.name} -> H: ${s.score1}, K: ${s.score2!==undefined?s.score2:'-'}`) ];
  navigator.clipboard.writeText(lines.join('\n')).then(()=>showToast("KopyalandÄ±!"));
}

function createCSVContent(data) {
  let csv = "Oturum Adayi,Puanlayici,Cinsiyet,Yas,GANO,Holistik Puan,Kontrol Puan\n";
  data.scores.forEach(s => {
    csv += `"${data.speaker}","${s.name}","${s.gender||''}","${s.age||''}","${s.gpa||''}","${s.score1}","${s.score2!==undefined?s.score2:''}"\n`;
  });
  return csv;
}

function triggerDownload(csvContent, fileName) {
  const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = fileName;
  link.style.display = 'none';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function downloadSingleReportCSV(isHistory = false) {
  const data = isHistory ? lastHistItem : lastReport;
  if(!data) return;
  const csv = createCSVContent(data);
  triggerDownload(csv, `Rapor_${data.speaker.replace(/\s+/g, '_')}.csv`);
}

function downloadAllHistoryCSV() {
  if(!allHistory || allHistory.length === 0) { showToast("GeÃ§miÅŸ veri yok."); return; }
  let csv = "Oturum Adayi,Tarih,Puanlayici,Cinsiyet,Yas,GANO,Holistik Puan,Kontrol Puan\n";
  allHistory.forEach(session => {
    session.scores.forEach(s => {
      csv += `"${session.speaker}","${session.date}","${s.name}","${s.gender||''}","${s.age||''}","${s.gpa||''}","${s.score1}","${s.score2!==undefined?s.score2:''}"\n`;
    });
  });
  triggerDownload(csv, `Tum_Gecmis_Raporlar.csv`);
}

async function loadHistory(){
  const el=document.getElementById('historyList'); el.innerHTML='<div style="text-align:center;padding:1rem;color:var(--muted)">YÃ¼kleniyor...</div>';
  try{
    const data=await api({action:'history'});
    if(!data.history||data.history.length===0){ el.innerHTML='<div style="text-align:center;padding:1rem;color:var(--muted)">GeÃ§miÅŸ yok.</div>'; return; }
    allHistory = data.history;
    el.innerHTML='';
    data.history.forEach(item=>{
      const s1_m = item.stats.s1 ? item.stats.s1.mean : (item.stats.mean||'-');
      const s2_m = item.stats.s2 ? item.stats.s2.mean : '-';
      el.innerHTML+=`<div class="history-item" onclick='showHistDetail(${JSON.stringify(item).replace(/'/g,"&#39;")})'><div style="font-weight:600">${item.speaker} <span style="font-weight:normal;font-size:.75rem;color:var(--muted);float:right">${item.date}</span></div><div style="font-size:.8rem;color:var(--muted);margin-top:.3rem">ğŸ‘¥ ${item.stats.n} | H. Ort: ${s1_m} | K. Ort: ${s2_m}</div></div>`;
    });
  }catch(e){ el.innerHTML='YÃ¼klenemedi.'; }
}

function showHistDetail(item){ 
  lastHistItem=item; 
  document.getElementById('histDetailCard').style.display='block'; 
  document.getElementById('hdTitle').textContent=item.speaker; 
  document.getElementById('hdDate').textContent=item.date; 
  renderReport({speaker:item.speaker, scores:item.scores, stats:item.stats}, 'hd'); 
  document.getElementById('histDetailCard').scrollIntoView({behavior:'smooth'});
}
function closeHistDetail(){ document.getElementById('histDetailCard').style.display='none'; }

initScorer();
if(savedPass) showTeacherPanel();
</script>
</body>
</html>
