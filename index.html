<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Candidate Scoring System</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root { --ink: #1a1a2e; --paper: #f5f0e8; --accent: #c8410a; --green: #2d6a4f; --muted: #7a7a8a; --border: #d9d2c4; --card: #fff; --shadow: 0 2px 20px rgba(26,26,46,.09); }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--paper);color:var(--ink);min-height:100vh;padding-bottom:2rem}
.nav{background:var(--ink);color:#fff;padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:60px}
.nav-brand{font-family:'DM Serif Display',serif;font-size:1.15rem}
.nav-tabs{display:flex;gap:.2rem}
.nav-tab{padding:.4rem 1rem;border-radius:6px;border:none;background:transparent;color:rgba(255,255,255,.5);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;cursor:pointer;transition:all .2s}
.nav-tab.active,.nav-tab:hover{background:rgba(255,255,255,.14);color:#fff}
.statusbar{text-align:center;padding:.4rem 1rem;font-size:.82rem;font-weight:500;display:none}
.statusbar.visible{display:block} .statusbar.open{background:var(--green);color:#fff} .statusbar.closed{background:var(--accent);color:#fff} .statusbar.waiting{background:#777;color:#fff}
.view{display:none;padding:2rem 1.25rem;max-width:750px;margin:0 auto}
.view.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.75rem;box-shadow:var(--shadow);margin-bottom:1.25rem}
.card-title{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:.25rem}
.card-sub{color:var(--muted);font-size:.85rem;margin-bottom:1.4rem}
label{display:block;font-size:.78rem;font-weight:600;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:.4rem}
input[type=text], input[type=number], input[type=password], select{width:100%;padding:.7rem .95rem;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:1rem;color:var(--ink);background:var(--paper);outline:none;transition:border-color .2s;margin-bottom:.9rem}
input:focus, select:focus{border-color:var(--ink)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.45rem;padding:.7rem 1.5rem;border-radius:10px;border:none;font-family:'DM Sans',sans-serif;font-size:.92rem;font-weight:600;cursor:pointer;transition:all .2s;width:100%}
.btn-primary{background:var(--ink);color:#fff} .btn-primary:hover:not(:disabled){background:#2d2d4a;}
.btn-danger{background:var(--accent);color:#fff} .btn-success{background:var(--green);color:#fff}
.btn-outline{background:transparent;color:var(--ink);border:1.5px solid var(--border)}
.btn-sm{padding:.45rem 1rem;font-size:.82rem;width:auto}
.btn:disabled{opacity:.4;cursor:not-allowed}
.score-display{text-align:center;margin:1rem 0 .4rem}
.score-big{font-family:'DM Serif Display',serif;font-size:5rem;line-height:1;transition:color .2s}
.score-range{color:var(--muted);font-size:.8rem;margin-top:.2rem}
input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:var(--border);outline:none;margin:.9rem 0;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:var(--ink);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2);transition:transform .15s}
.checklist-container { display:flex; flex-direction:column; gap:.6rem; margin-bottom:1.5rem; }
.check-item { display:flex; flex-direction:column; gap:.8rem; background:var(--paper); padding:1.2rem; border-radius:10px; border:1px solid var(--border); }
@media(min-width: 550px) { .check-item { flex-direction:row; align-items:center; justify-content:space-between; } }
.check-item label { margin:0; color:var(--ink); font-weight:500; font-size:.92rem; text-transform:none; letter-spacing:normal; flex:1; cursor:pointer; }
.radio-group { display: flex; gap: 0.5rem; flex-shrink: 0; }
.radio-btn { padding: 0.5rem 1.2rem; border-radius: 8px; border: 1.5px solid var(--border); font-size: 0.85rem; font-weight: 600; color: var(--muted); cursor: pointer; transition: all 0.2s; background: #fff; text-align:center; flex:1; }
.radio-btn.yes.active { background: var(--green); border-color: var(--green); color: #fff; }
.radio-btn.no.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.success-msg{text-align:center;padding:1.8rem 1rem;display:none} .success-icon{font-size:3.2rem;margin-bottom:.6rem}
.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;margin:.5rem 0}
@media(max-width: 450px) { .stat-grid { grid-template-columns: 1fr 1fr; } }
.stat-box{background:var(--paper);border:1px solid var(--border);border-radius:12px;padding:.8rem;text-align:center}
.stat-label{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:.25rem}
.stat-value{font-family:'DM Serif Display',serif;font-size:1.6rem;color:var(--ink)}
.score-item{display:flex;flex-direction:column;padding:.6rem .8rem;border-radius:8px;font-size:.88rem;margin-bottom:.4rem;background:var(--paper);border:1px solid var(--border)}
.sbadge{display:inline-flex;align-items:center;gap:.4rem;background:var(--paper);border:1px solid var(--border);border-radius:8px;padding:.3rem .75rem;font-size:.8rem;color:var(--muted);margin-bottom:.9rem}
.dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite} .dot.off{background:var(--muted);animation:none}
.student-row{display:flex;align-items:center;justify-content:space-between;padding:.65rem .85rem;border-radius:10px;border:1px solid var(--border);margin-bottom:.5rem;background:var(--paper);}
.student-row.active-session{border-color:var(--green);background:#f0faf5;}
.history-item{border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:.75rem;cursor:pointer;background:var(--card); display:flex; justify-content:space-between; align-items:center;}
.history-item:hover{box-shadow:var(--shadow)}
hr{border:none;border-top:1px solid var(--border);margin:1.1rem 0}
.spin{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:rot .7s linear infinite;margin-right:.35rem}
@keyframes rot{to{transform:rotate(360deg)}} @keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}
.toast{position:fixed;bottom:1.4rem;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ink);color:#fff;padding:.65rem 1.3rem;border-radius:10px;font-size:.85rem;font-weight:500;transition:transform .3s ease;z-index:9999;}
.toast.show{transform:translateX(-50%) translateY(0)}
.waiting-screen{text-align:center;padding:2.5rem 1rem}
.demo-box { background:#f9f9f9; padding:1rem; border-radius:10px; margin-top:.5rem; font-size:.85rem;}
.demo-box span { display:inline-block; margin-right:1rem; margin-bottom:.5rem; }
.edit-list-item { display:flex; gap:.5rem; margin-bottom:.5rem; }
.top-score-text { font-size: 0.8rem; color: var(--muted); margin-top: 0.3rem; text-align: center; }
</style>
</head>
<body>

<nav class="nav">
  <div class="nav-brand">üìã Scoring System</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showView('scorer')">Scorer</button>
    <button class="nav-tab" onclick="showView('teacher')">Teacher</button>
  </div>
</nav>
<div class="statusbar" id="statusBar"></div>

<div class="view active" id="view-scorer">
  <div id="scorerLoginScreen">
    <div class="card">
      <div class="card-title">Join System</div>
      <div class="card-sub">Please enter your details completely before evaluation. Data will be used for comparative analysis.</div>
      
      <label>Full Name</label>
      <input type="text" id="scorerName" placeholder="e.g., John Doe">
      
      <label>Gender</label>
      <select id="scorerGender">
        <option value="">Select...</option>
        <option value="Female">Female</option>
        <option value="Male">Male</option>
      </select>
      
      <label>Age</label>
      <input type="number" id="scorerAge" placeholder="e.g., 21">
      
      <label>Grade Point Average (GPA)</label>
      <input type="number" step="0.01" id="scorerGpa" placeholder="e.g., 3.20">
      
      <button class="btn btn-primary" onclick="loginScorer()" style="margin-top:1rem">Enter System ‚Üí</button>
    </div>
  </div>

  <div id="scorerMainScreen" style="display:none">
    <div class="card" id="scorerWaitCard">
      <div class="waiting-screen">
        <div style="font-size:3rem;margin-bottom:1rem">‚è≥</div>
        <h3>Waiting for Session</h3>
        <p style="color:var(--muted);font-size:.88rem">It will appear here when the teacher opens a session for a candidate.</p>
        <p style="margin-top:.75rem;font-size:.8rem;color:var(--muted)" id="scorerWelcomeName"></p>
        <button class="btn btn-outline btn-sm" style="margin-top:1.5rem" onclick="logoutScorer()">Log Out / Update Info</button>
      </div>
    </div>

    <div class="card" id="scorerActiveCard" style="display:none">
      <div class="sbadge"><div class="dot" id="scoreDot"></div><span id="scoreBadgeTxt">Session active</span></div>
      <div class="card-title" id="scorerSpeakerTitle">‚Äî</div>
      
      <div id="scoringStep1">
        <div class="card-sub">Step 1: Rate the general performance of the speaking candidate.</div>
        <div class="score-display">
          <div class="score-big" id="scoreDisplay">10</div>
          <div class="score-range">Please rate on a scale of 0 to 20.</div>
        </div>
        <input type="range" min="0" max="20" value="10" id="scoreSlider" oninput="updateSlider(this.value)">
        <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-bottom:1rem"><span>0</span><span>10</span><span>20</span></div>
        <hr>
        <button class="btn btn-primary" onclick="goToStep2()">Next Step ‚Üí</button>
      </div>

      <div id="scoringStep2" style="display:none">
        <div class="card-sub">Step 2: Please mark the following items based on the student's performance.</div>
        <div class="checklist-container" id="checklist"></div>
        <hr>
        <button class="btn btn-success" id="submitBtn" onclick="submitScores()">‚úì Send Evaluation</button>
      </div>

      <div class="success-msg" id="successMsg">
        <div class="success-icon" id="successIcon">‚úÖ</div>
        <h3 id="successTitle">Evaluation Received!</h3>
        <p id="successDetail"></p>
        <p style="margin-top:.75rem;font-size:.82rem;color:var(--muted)">The screen will update automatically when the next session opens.</p>
      </div>
    </div>
  </div>
</div>

<div class="view" id="view-teacher">

  <div class="card" id="teacherLoginCard">
    <div class="card-title">Teacher Login</div>
    <div class="card-sub">Enter the admin password to access the panel.</div>
    <label>Password</label>
    <input type="password" id="teacherPass" placeholder="Your Password" onkeydown="if(event.key==='Enter')loginTeacher()"/>
    <button class="btn btn-primary" onclick="loginTeacher()">Log In</button>
  </div>

  <div id="teacherPanel" style="display:none">
    
    <div class="card">
      <div class="card-title">Candidate & Session Management</div>
      <div style="display:flex;gap:.5rem;margin-bottom:1rem;margin-top:1rem">
        <input type="text" id="newStudentName" placeholder="Add candidate full name..." style="margin-bottom:0;flex:1" onkeydown="if(event.key==='Enter')addStudent()"/>
        <button class="btn btn-outline btn-sm" onclick="addStudent()">+ Add</button>
      </div>
      <div id="studentList"></div>
    </div>

    <div class="card" id="activeSessionInfo" style="display:none; border-color:var(--green)">
      <div class="sbadge"><div class="dot" id="teacherDot"></div><span id="teacherBadgeTxt">Session active</span></div>
      <div class="card-title" id="activeSessionSpeaker">‚Äî</div>
      <div id="activeScoreCount" style="color:var(--muted);font-size:.88rem;margin-bottom:1rem">No evaluations received yet.</div>
      <button class="btn btn-danger" id="closeBtn" onclick="closeSession()">‚ñ† Close Session and Show Report</button>
    </div>

    <div class="card" id="reportCard" style="display:none">
      <div class="card-title">üìä Comparative Report</div>
      <div class="card-sub" id="reportSpeaker"></div>
      
      <div class="demo-box" id="rDemoBox"></div>

      <div style="font-weight:bold; margin-top:1.5rem; font-size:.9rem; color:var(--accent)">Holistic Evaluation (Step 1)</div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Mean</div><div class="stat-value" id="rMean1">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Min/Max</div><div class="stat-value" id="rMinMax1" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Std. Dev</div><div class="stat-value" id="rStd1" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
      </div>
      <div class="top-score-text" id="rTop3_1"></div>
      
      <div style="font-weight:bold; margin-top:1.5rem; font-size:.9rem; color:var(--green)">Checklist (Step 2)</div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Mean</div><div class="stat-value" id="rMean2">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Min/Max</div><div class="stat-value" id="rMinMax2" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Std. Dev</div><div class="stat-value" id="rStd2" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
      </div>
      <div class="top-score-text" id="rTop3_2"></div>

      <div style="margin:1.5rem 0 .5rem; font-weight:bold; font-size:.85rem; color:var(--muted)">INDIVIDUAL EVALUATIONS (<span id="rCount">0</span> People)</div>
      <div id="rList"></div>
      <hr>
      <div style="display:flex; gap:0.5rem">
        <button class="btn btn-success" style="flex:2" onclick="downloadSingleReportCSV()">üì• Download Report as Excel (CSV)</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Checklist Management</div>
      <div class="card-sub">You can edit the questions going to scorers here. <br><small style="color:var(--accent)">(Changes will take effect in the next session.)</small></div>
      <div id="teacherChecklistContainer"></div>
      <button class="btn btn-outline btn-sm" style="margin-top:.5rem" onclick="addChecklistItem()">+ Add New Item</button>
      <hr>
      <button class="btn btn-primary" onclick="saveChecklistToDB()">üíæ Save List to Server</button>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem">
        <div class="card-title" style="margin:0">Past Sessions</div>
        <div style="display:flex; gap:0.5rem;">
          <button class="btn btn-danger btn-sm" onclick="clearAllHistory()">Delete All</button>
          <button class="btn btn-success btn-sm" onclick="downloadAllHistoryCSV()">Download All üì•</button>
        </div>
      </div>
      <div class="card-sub">You can delete and bulk download. Click on an item to see report details.</div>
      <div id="historyList"></div>
    </div>
    
    <div class="card" id="histDetailCard" style="display:none">
      <button class="btn btn-outline btn-sm" style="margin-bottom:1rem" onclick="closeHistDetail()">‚Üê Go Back</button>
      <div class="card-title" id="hdTitle"></div><div class="card-sub" id="hdDate"></div>
      
      <div class="demo-box" id="hdDemoBox"></div>
      
      <div style="font-weight:bold; margin-top:1.5rem; font-size:.9rem; color:var(--accent)">Holistic Evaluation (Step 1)</div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Mean</div><div class="stat-value" id="hdMean1">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Min/Max</div><div class="stat-value" id="hdMinMax1" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Std. Dev</div><div class="stat-value" id="hdStd1" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
      </div>
      <div class="top-score-text" id="hdTop3_1"></div>
      
      <div style="font-weight:bold; margin-top:1.5rem; font-size:.9rem; color:var(--green)">Checklist (Step 2)</div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Mean</div><div class="stat-value" id="hdMean2">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Min/Max</div><div class="stat-value" id="hdMinMax2" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
        <div class="stat-box"><div class="stat-label">Std. Dev</div><div class="stat-value" id="hdStd2" style="font-size:1.2rem; line-height:1.6">‚Äî</div></div>
      </div>
      <div class="top-score-text" id="hdTop3_2"></div>

      <div id="hdList" style="margin-top:1.5rem"></div>
      <hr>
      <button class="btn btn-success" onclick="downloadSingleReportCSV(true)">üì• Download This Session as Excel (CSV)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ==========================================
// API Lƒ∞NKƒ∞Nƒ∞Z (G√ºncel Daƒüƒ±tƒ±m Varsa Buraya Ekleyin)
const API = "https://script.google.com/macros/s/AKfycbz5g8rO3flpCdpOUqDm_mh5CXEMQNj5MBPNNaQQtW2dDoMIaGCtSF7E3sbKAxwoHz8y/exec";
// ==========================================

let myScorerData = JSON.parse(localStorage.getItem("scorerData") || "null");
let scorerVoted = false; let currentSpeaker = "";
let scorerPollId = null, teacherPollId = null;
let lastReport = null, lastHistItem = null, allHistory = [];
let students = []; let activeStudentIdx = -1;
let savedPass = localStorage.getItem("teacherPass") || "";
let tempScore1 = 0; 
let activeChecklist = []; // Sunucudan gelen maddeler

function showToast(msg, ms=2800){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }
function showView(v){ document.querySelectorAll('.view').forEach(el=>el.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.querySelectorAll('.nav-tab').forEach((el,i)=>el.classList.toggle('active',(i===0&&v==='scorer')||(i===1&&v==='teacher'))); }
function setStatusBar(state,text){ const sb=document.getElementById('statusBar'); if(!state){sb.className='statusbar';return;} sb.className='statusbar visible '+state; sb.textContent=text; }
async function api(params){ const qs = new URLSearchParams(params).toString(); const res = await fetch(API + '?' + qs); if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); }
function updateSlider(v){ const el=document.getElementById('scoreDisplay'); if(el){ el.textContent=v; el.style.color=(v/20)>.65?'#1a6640':(v/20)>.35?'#7a5a10':'#c8410a'; } }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCORER FONKSƒ∞YONLARI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initScorer(){ 
  if(myScorerData && myScorerData.name){ 
    document.getElementById('scorerLoginScreen').style.display='none'; 
    document.getElementById('scorerMainScreen').style.display='block'; 
    document.getElementById('scorerWelcomeName').textContent='Welcome, '+myScorerData.name+' üëã'; 
    startScorerPoll(); 
  } 
}

function loginScorer(){ 
  const name = document.getElementById('scorerName').value.trim();
  const gender = document.getElementById('scorerGender').value;
  const age = document.getElementById('scorerAge').value.trim();
  const gpa = document.getElementById('scorerGpa').value.trim();
  
  if(!name || !gender || !age || !gpa){ showToast("Please fill in all fields."); return; }
  
  myScorerData = { name: name, gender: gender, age: age, gpa: gpa };
  localStorage.setItem("scorerData", JSON.stringify(myScorerData)); 
  initScorer(); 
}

function logoutScorer() {
  localStorage.removeItem("scorerData");
  myScorerData = null;
  if(scorerPollId) clearInterval(scorerPollId);
  document.getElementById('scorerLoginScreen').style.display='block'; 
  document.getElementById('scorerMainScreen').style.display='none'; 
}

function renderScorerChecklist(list) {
  const container = document.getElementById('checklist');
  container.innerHTML = '';
  list.forEach((item, index) => {
    container.innerHTML += `
      <div class="check-item" id="item-${index}">
        <label onclick="selectCheckRadio(${index}, 'yes')">${index+1}. ${item}</label>
        <div class="radio-group">
          <div class="radio-btn yes" onclick="selectCheckRadio(${index}, 'yes')">YES</div>
          <div class="radio-btn no" onclick="selectCheckRadio(${index}, 'no')">NO</div>
        </div>
      </div>`;
  });
}

function selectCheckRadio(index, choice) {
  const itemDiv = document.getElementById(`item-${index}`);
  const yesBtn = itemDiv.querySelector('.radio-btn.yes');
  const noBtn = itemDiv.querySelector('.radio-btn.no');
  if (choice === 'yes') { yesBtn.classList.add('active'); noBtn.classList.remove('active'); } 
  else { noBtn.classList.add('active'); yesBtn.classList.remove('active'); }
}

function startScorerPoll(){ if(scorerPollId) clearInterval(scorerPollId); checkScorerStatus(); scorerPollId=setInterval(checkScorerStatus,3000); }

async function checkScorerStatus(){
  try{
    const data=await api({action:'status'});
    if(JSON.stringify(activeChecklist) !== JSON.stringify(data.checklist)) {
      activeChecklist = data.checklist;
      renderScorerChecklist(activeChecklist);
    }

    if(data.session_active){
      if(data.speaker !== currentSpeaker){ currentSpeaker=data.speaker; scorerVoted=false; openScoringUI(data.speaker); } 
      else if(scorerVoted){ showScorerVotedWait(); } 
      else { showScorerActiveCard(); }
      setStatusBar('open','üü¢ Active session ‚Äî evaluation open');
    } else {
      if(currentSpeaker && !scorerVoted){ showScorerClosed(); }
      currentSpeaker=''; if(!scorerVoted) showScorerWait(); setStatusBar('waiting','‚è≥ Waiting for session‚Ä¶');
    }
  }catch(e){}
}

function showScorerWait(){ document.getElementById('scorerWaitCard').style.display='block'; document.getElementById('scorerActiveCard').style.display='none'; }
function showScorerActiveCard(){ document.getElementById('scorerWaitCard').style.display='none'; document.getElementById('scorerActiveCard').style.display='block'; }

function openScoringUI(speaker){
  showScorerActiveCard(); document.getElementById('scoreDot').classList.remove('off'); document.getElementById('scorerSpeakerTitle').textContent=speaker;
  document.getElementById('scoringStep1').style.display='block'; document.getElementById('scoringStep2').style.display='none'; document.getElementById('successMsg').style.display='none';
  const slider=document.getElementById('scoreSlider'); if(slider) slider.value=10; updateSlider(10);
  document.querySelectorAll('.checklist-container .radio-btn').forEach(btn => btn.classList.remove('active'));
  const btn=document.getElementById('submitBtn'); if(btn){btn.disabled=false;btn.textContent='‚úì Send Evaluation';}
}

function goToStep2() {
  tempScore1 = parseInt(document.getElementById('scoreSlider').value);
  document.getElementById('scoringStep1').style.display = 'none';
  document.getElementById('scoringStep2').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showScorerClosed(){
  document.getElementById('scoreDot').classList.add('off'); document.getElementById('scoringStep1').style.display='none'; document.getElementById('scoringStep2').style.display='none';
  document.getElementById('successIcon').textContent='‚õî'; document.getElementById('successTitle').textContent='Session closed';
  document.getElementById('successDetail').textContent='Evaluation time expired.'; document.getElementById('successMsg').style.display='block'; setStatusBar('closed','‚õî Session closed');
}
function showScorerVotedWait(){ showScorerActiveCard(); document.getElementById('scoringStep1').style.display='none'; document.getElementById('scoringStep2').style.display='none'; document.getElementById('successMsg').style.display='block'; }

async function submitScores(){
  const totalItems = activeChecklist.length;
  const answeredItems = document.querySelectorAll('.checklist-container .radio-btn.active').length;
  if (answeredItems < totalItems) { showToast("Please mark all items."); return; }

  const s1 = tempScore1;
  const yesCount = document.querySelectorAll('.checklist-container .radio-btn.yes.active').length;
  
  // FORM√úL: (Evet Sayƒ±sƒ± / Toplam Soru Sayƒ±sƒ±) * 20
  const s2 = Math.round((yesCount / totalItems) * 20);
  
  const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerHTML='<span class="spin"></span>Sending‚Ä¶';
  scorerVoted=true;
  document.getElementById('successDetail').innerHTML=`Thank you for your contribution.`;
  document.getElementById('successIcon').textContent='‚úÖ'; document.getElementById('successTitle').textContent='Evaluation Received!';
  document.getElementById('scoringStep2').style.display='none'; document.getElementById('successMsg').style.display='block';

  try{
    const data=await api({ action:'score', rater:myScorerData.name, gender:myScorerData.gender, age:myScorerData.age, gpa:myScorerData.gpa, score1:s1, score2:s2 });
    if(data.status!=='ok' && data.status!=='duplicate'){
      scorerVoted=false; document.getElementById('scoringStep2').style.display='block'; document.getElementById('successMsg').style.display='none'; btn.disabled=false; btn.textContent='‚úì Send Evaluation'; showToast(data.message||"Error.");
    }
  }catch(e){ scorerVoted=false; document.getElementById('scoringStep2').style.display='block'; document.getElementById('successMsg').style.display='none'; btn.disabled=false; btn.textContent='‚úì Send Evaluation'; showToast("Connection error."); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEACHER FONKSƒ∞YONLARI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loginTeacher(){
  const pass = document.getElementById('teacherPass').value.trim();
  if(!pass){showToast("Enter password!");return;}
  const btn = document.querySelector('#teacherLoginCard .btn-primary'); btn.disabled=true; btn.textContent="Please wait...";
  try {
    const data = await api({action: 'verify_pass', pass: pass});
    if(data.status === 'ok') { localStorage.setItem("teacherPass", pass); savedPass = pass; showTeacherPanel(); } 
    else { showToast("Incorrect password!"); }
  } catch(e) { showToast("Connection error!"); }
  btn.disabled = false; btn.textContent = "Log In";
}

function showTeacherPanel(){ showView('teacher'); document.getElementById('teacherLoginCard').style.display='none'; document.getElementById('teacherPanel').style.display='block'; renderStudentList(); loadHistory(); startTeacherPoll(); restoreTeacherSession(); }

async function restoreTeacherSession(){
  try{
    const data=await api({action:'status'});
    if(data.students) { students = data.students; renderStudentList(); }
    if(data.checklist) { renderTeacherChecklist(data.checklist); }

    if(data.session_active){
      activeStudentIdx = students.indexOf(data.speaker);
      document.getElementById('activeSessionInfo').style.display='block'; document.getElementById('activeSessionSpeaker').textContent=data.speaker;
      document.getElementById('activeScoreCount').textContent = data.score_count===0 ? 'Waiting...' : data.score_count+' evaluations received.';
      document.getElementById('teacherDot').classList.remove('off'); setStatusBar('open','üü¢ Active session ‚Äî evaluation open');
    } else { activeStudentIdx=-1; document.getElementById('activeSessionInfo').style.display='none'; setStatusBar(null); renderStudentList(); }
  }catch(e){}
}

async function addStudent(){
  const inp=document.getElementById('newStudentName'); const name=inp.value.trim(); if(!name) return;
  const btn = inp.nextElementSibling; btn.disabled = true; btn.textContent = "...";
  try {
    const data = await api({action: 'add_student', student: name, pass: savedPass});
    if(data.status === 'ok') { students = data.students; inp.value = ''; renderStudentList(); showToast("Added."); }
  } catch(e) { showToast("Error!"); }
  btn.disabled = false; btn.textContent = "+ Add";
}

async function removeStudent(i){
  if(activeStudentIdx===i){showToast("Close the active session.");return;}
  try {
    const data = await api({action: 'remove_student', student: students[i], pass: savedPass});
    if(data.status === 'ok') { students = data.students; if(activeStudentIdx > i) activeStudentIdx--; renderStudentList(); }
  } catch(e) { showToast("Error!"); }
}

function renderStudentList(){
  const el=document.getElementById('studentList');
  if(!students.length){ el.innerHTML='<div style="text-align:center;padding:1rem;color:var(--muted);font-size:.9rem">Candidate list is empty.</div>'; return; }
  el.innerHTML='';
  students.forEach((name,i)=>{
    const isActive=(activeStudentIdx===i);
    el.innerHTML+=`<div class="student-row ${isActive?'active-session':''}"><span class="student-name">${isActive?'üü¢ ':''}${name}</span><span class="student-count" id="scount-${i}"></span><div class="row-actions">${isActive ? `<button class="btn btn-danger btn-sm" onclick="closeSession()">Close</button>` : `<button class="btn btn-success btn-sm" onclick="startSession(${i})" ${activeStudentIdx!==-1?'disabled':''}>Open</button><button class="btn btn-outline btn-sm" onclick="removeStudent(${i})" ${activeStudentIdx!==-1?'disabled':''}>‚úï</button>`}</div></div>`;
  });
}

async function startSession(idx){
  const speaker=students[idx]; document.querySelectorAll('.row-actions .btn').forEach(b=>b.disabled=true);
  try{
    const data=await api({action:'start', speaker:speaker, pass:savedPass});
    if(data.status==='ok'){ activeStudentIdx=idx; renderStudentList(); document.getElementById('activeSessionInfo').style.display='block'; document.getElementById('activeSessionSpeaker').textContent=speaker; document.getElementById('activeScoreCount').textContent='Waiting...'; document.getElementById('reportCard').style.display='none'; document.getElementById('teacherDot').classList.remove('off'); setStatusBar('open','üü¢ Active session ‚Äî evaluation open'); } 
  }catch(e){ showToast("Error!"); renderStudentList(); }
}

async function closeSession(){
  const btn=document.getElementById('closeBtn'); btn.disabled=true; btn.innerHTML='Closing...';
  try{
    const data=await api({action:'close', pass:savedPass});
    activeStudentIdx=-1; renderStudentList(); document.getElementById('activeSessionInfo').style.display='none'; document.getElementById('teacherDot').classList.add('off'); setStatusBar('closed','‚õî Session closed');
    if(!data.scores||data.scores.length===0){ showToast("No evaluation entered."); setStatusBar(null); } 
    else { renderReport(data,'r'); document.getElementById('reportCard').style.display='block'; }
    loadHistory(); btn.disabled=false; btn.textContent='‚ñ† Close Session and Show Report';
  }catch(e){ showToast("Error!"); btn.disabled=false; btn.textContent='‚ñ† Close Session'; }
}

function startTeacherPoll(){
  if(teacherPollId) clearInterval(teacherPollId);
  teacherPollId=setInterval(async()=>{
    try{
      const data=await api({action:'status'});
      if(data.students && JSON.stringify(students) !== JSON.stringify(data.students)) { students = data.students; renderStudentList(); }
      if(activeStudentIdx===-1) return;
      if(data.session_active){
        const n=data.score_count; document.getElementById('activeScoreCount').textContent = n===0?'Waiting...':n+' people evaluated.';
        const sc=document.getElementById('scount-'+activeStudentIdx); if(sc&&n>0) sc.textContent=n+' submissions';
      }
    }catch(e){}
  },3000);
}

// ‚ïê‚ïê‚ïê‚ïê KONTROL Lƒ∞STESƒ∞ Y√ñNETƒ∞Mƒ∞ ‚ïê‚ïê‚ïê‚ïê
function renderTeacherChecklist(list) {
  const container = document.getElementById('teacherChecklistContainer');
  container.innerHTML = '';
  list.forEach((item, index) => {
    container.innerHTML += `
      <div class="edit-list-item">
        <input type="text" class="t-check-input" value="${item}" style="margin:0">
        <button class="btn btn-outline btn-sm" onclick="this.parentElement.remove()">Delete</button>
      </div>`;
  });
}
function addChecklistItem() {
  const container = document.getElementById('teacherChecklistContainer');
  container.innerHTML += `<div class="edit-list-item"><input type="text" class="t-check-input" placeholder="New item..." style="margin:0"><button class="btn btn-outline btn-sm" onclick="this.parentElement.remove()">Delete</button></div>`;
}
async function saveChecklistToDB() {
  const inputs = document.querySelectorAll('.t-check-input');
  const newList = Array.from(inputs).map(inp => inp.value.trim()).filter(val => val !== "");
  if(newList.length === 0) { showToast("List cannot be empty."); return; }
  try {
    const data = await api({ action: 'save_checklist', pass: savedPass, listData: JSON.stringify(newList) });
    if(data.status === 'ok') showToast("List updated."); else showToast("Error!");
  } catch(e) { showToast("Connection error."); }
}

// ‚ïê‚ïê‚ïê‚ïê GE√áMƒ∞≈û Y√ñNETƒ∞Mƒ∞ ‚ïê‚ïê‚ïê‚ïê
async function deleteHistory(sessionId) {
  if(!confirm("Are you sure you want to delete this session?")) return;
  try {
    const data = await api({action: 'delete_history', pass: savedPass, sessionId: sessionId});
    if(data.status === 'ok') { showToast("Record deleted."); loadHistory(); document.getElementById('histDetailCard').style.display='none'; }
  } catch(e) { showToast("Connection error!"); }
}

async function clearAllHistory() {
  if(!confirm("Are you sure you want to permanently delete all history records?")) return;
  try {
    const data = await api({action: 'clear_history', pass: savedPass});
    if(data.status === 'ok') { showToast("All history deleted."); loadHistory(); document.getElementById('histDetailCard').style.display='none'; }
  } catch(e) { showToast("Connection error!"); }
}

// ‚ïê‚ïê‚ïê‚ïê RAPOR VE ƒ∞NDƒ∞RME ‚ïê‚ïê‚ïê‚ïê
function formatTop3(top3Array) {
  if(!top3Array || top3Array.length === 0) return "Most given score: No Data";
  return "Most given: " + top3Array.map(t => `<b style="color:var(--ink)">${t.val}</b> (${t.count} people)`).join(', ');
}

function generateDemographics(scores) {
  let f=0, m=0, totalAge=0, totalGpa=0;
  scores.forEach(s => {
    if(s.gender === "Female") f++; else if(s.gender === "Male") m++;
    totalAge += parseInt(s.age) || 0; totalGpa += parseFloat(s.gpa) || 0;
  });
  const n = scores.length || 1;
  return `<span><b>Female:</b> ${f}</span> <span><b>Male:</b> ${m}</span> <span><b>Avg Age:</b> ${(totalAge/n).toFixed(1)}</span> <span><b>Avg GPA:</b> ${(totalGpa/n).toFixed(2)}</span>`;
}

function renderReport(data,prefix){
  const{speaker,scores,stats}=data; 
  if(prefix==='r') lastReport=data; else lastHistItem=data;
  
  // Geriye d√∂n√ºk uyumluluk ve g√ºvenlik (eski verilerde stats.s1 olmayabilir)
  const s1_mean = stats.s1 ? stats.s1.mean : (stats.mean || '-');
  const s1_std = stats.s1 ? stats.s1.std : (stats.std || '-');
  const s1_minmax = stats.s1 ? `${stats.s1.min} / ${stats.s1.max}` : '-';
  const s1_top3 = stats.s1 ? formatTop3(stats.s1.top3) : '-';

  const s2_mean = stats.s2 ? stats.s2.mean : '-';
  const s2_std = stats.s2 ? stats.s2.std : '-';
  const s2_minmax = stats.s2 ? `${stats.s2.min} / ${stats.s2.max}` : '-';
  const s2_top3 = stats.s2 ? formatTop3(stats.s2.top3) : '-';

  // Deƒüerleri Ekrana Yazdƒ±r
  document.getElementById(prefix+'Mean1').textContent = s1_mean; 
  document.getElementById(prefix+'Std1').textContent = s1_std;
  document.getElementById(prefix+'MinMax1').textContent = s1_minmax;
  document.getElementById(prefix+'Top3_1').innerHTML = s1_top3;

  document.getElementById(prefix+'Mean2').textContent = s2_mean; 
  document.getElementById(prefix+'Std2').textContent = s2_std;
  document.getElementById(prefix+'MinMax2').textContent = s2_minmax;
  document.getElementById(prefix+'Top3_2').innerHTML = s2_top3;
  
  if(prefix==='r') { document.getElementById('reportSpeaker').textContent=speaker; document.getElementById('rCount').textContent=stats.n; document.getElementById('rDemoBox').innerHTML = generateDemographics(scores); }
  else { document.getElementById('hdDemoBox').innerHTML = generateDemographics(scores); }

  const list=document.getElementById(prefix+'List'); list.innerHTML='';
  [...scores].sort((a,b)=>b.score1-a.score1).forEach(s=>{
    const ageInfo = s.age && s.age !== "0" ? ` (${s.gender?s.gender.charAt(0):''}, Age:${s.age}, GPA:${s.gpa||''})` : '';
    const score2Text = s.score2 !== undefined ? s.score2 : '-';
    list.innerHTML+=`<div class="score-item"><div class="si-header"><span>${s.name} <span style="font-weight:normal;color:var(--muted);font-size:.75rem">${ageInfo}</span></span></div><div class="si-details"><span>Holistic: <b style="color:var(--ink)">${s.score1}/20</b></span><span>Checklist: <b style="color:var(--green)">${score2Text}/20</b></span></div></div>`;
  });
}

function copyReport(d){
  d=d||lastReport; if(!d) return;
  const lines = [ `REPORT ‚Äî ${d.speaker}`, `Holistic Avg: ${d.stats.s1?d.stats.s1.mean:d.stats.mean} | Checklist Avg: ${d.stats.s2?d.stats.s2.mean:'-'}`, ``, ...d.scores.map(s=>`${s.name} -> H: ${s.score1}, C: ${s.score2!==undefined?s.score2:'-'}`) ];
  navigator.clipboard.writeText(lines.join('\n')).then(()=>showToast("Copied!"));
}

// ‚ïê‚ïê‚ïê‚ïê CSV/EXCEL OLU≈ûTURUCU ‚ïê‚ïê‚ïê‚ïê
// T√úRKIYE B√ñLGE AYARLARI ƒ∞√áƒ∞N Vƒ∞RG√úL (,) YERƒ∞NE NOKTALI Vƒ∞RG√úL (;) KULLANILDI
function createCSVContent(data) {
  let csv = "Student Name;Scorer Full Name;Gender;Age;GPA;Holistic Score;Checklist Score\n";
  data.scores.forEach(s => {
    csv += `"${data.speaker}";"${s.name}";"${s.gender||''}";"${s.age||''}";"${s.gpa||''}";"${s.score1}";"${s.score2!==undefined?s.score2:''}"\n`;
  });
  return csv;
}

function triggerDownload(csvContent, fileName) {
  // UTF-8 BOM eklenerek Excel'de karakterlerin bozulmasƒ± √∂nlenir
  const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = fileName;
  link.style.display = 'none';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function downloadSingleReportCSV(isHistory = false) {
  const data = isHistory ? lastHistItem : lastReport;
  if(!data) return;
  const csv = createCSVContent(data);
  triggerDownload(csv, `Report_${data.speaker.replace(/\s+/g, '_')}.csv`);
}

function downloadAllHistoryCSV() {
  if(!allHistory || allHistory.length === 0) { showToast("No history data."); return; }
  let csv = "Date;Student Name;Scorer Full Name;Gender;Age;GPA;Holistic Score;Checklist Score\n";
  allHistory.forEach(session => {
    session.scores.forEach(s => {
      csv += `"${session.date}";"${session.speaker}";"${s.name}";"${s.gender||''}";"${s.age||''}";"${s.gpa||''}";"${s.score1}";"${s.score2!==undefined?s.score2:''}"\n`;
    });
  });
  triggerDownload(csv, `All_Past_Reports.csv`);
}

async function loadHistory(){
  const el=document.getElementById('historyList'); el.innerHTML='<div style="text-align:center;padding:1rem;color:var(--muted)">Loading...</div>';
  try{
    const data=await api({action:'history'});
    if(!data.history||data.history.length===0){ el.innerHTML='<div style="text-align:center;padding:1rem;color:var(--muted)">No history.</div>'; return; }
    allHistory = data.history;
    el.innerHTML='';
    
    // Ge√ßmi≈ü veriler array index'i √ºzerinden y√ºkleniyor (√ß√∂kme sorununu engeller)
    allHistory.forEach((item, index)=>{
      const s1_m = item.stats.s1 ? item.stats.s1.mean : (item.stats.mean||'-');
      const s2_m = item.stats.s2 ? item.stats.s2.mean : '-';
      el.innerHTML+=`
      <div class="history-item" onclick="showHistDetail(${index})">
        <div style="flex:1">
          <div style="font-weight:600">${item.speaker}</div>
          <div style="font-size:.8rem;color:var(--muted);margin-top:.3rem">üóìÔ∏è ${item.date} | üë• ${item.stats.n} People | H. Avg: ${s1_m}</div>
        </div>
        <button class="btn btn-outline btn-sm" style="border-color:var(--accent); color:var(--accent)" onclick="event.stopPropagation(); deleteHistory('${item.sessionId}')">Delete</button>
      </div>`;
    });
  }catch(e){ el.innerHTML='Could not load.'; }
}

function showHistDetail(index){ 
  const item = allHistory[index];
  lastHistItem=item; 
  document.getElementById('histDetailCard').style.display='block'; 
  document.getElementById('hdTitle').textContent=item.speaker; 
  document.getElementById('hdDate').textContent=item.date; 
  renderReport({speaker:item.speaker, scores:item.scores, stats:item.stats}, 'hd'); 
  document.getElementById('histDetailCard').scrollIntoView({behavior:'smooth'});
}
function closeHistDetail(){ document.getElementById('histDetailCard').style.display='none'; }

initScorer();
if(savedPass) showTeacherPanel();
</script>
</body>
</html>
